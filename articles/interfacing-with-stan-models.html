<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Interfacing with Stan models via BridgeStan â€¢ rmcmc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Interfacing with Stan models via BridgeStan">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rmcmc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/adjusting-noise-distribution.html">Adjusting the noise distribution in the Barker proposal</a></li>
    <li><a class="dropdown-item" href="../articles/barker-proposal.html">Robust gradient-based MCMC with the Barker proposal</a></li>
    <li><a class="dropdown-item" href="../articles/interfacing-with-stan-models.html">Interfacing with Stan models via BridgeStan</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UCL/rmcmc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Interfacing with Stan models via BridgeStan</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/UCL/rmcmc/blob/main/vignettes/articles/interfacing-with-stan-models.Rmd" class="external-link"><code>vignettes/articles/interfacing-with-stan-models.Rmd</code></a></small>
      <div class="d-none name"><code>interfacing-with-stan-models.Rmd</code></div>
    </div>

    
    
<p>The <code>rmcmc</code> package includes support for using the
probabilistic programming language Stan to define the target
distribution for inference via the <a href="https://roualdes.us/bridgestan/latest/languages/r.html" class="external-link">R
interface of the excellent BridgeStan package</a>. This article
illustrates how to use the Stan modelling syntax to define a model to
use with <code>rmcmc</code> using an example model and data from
computational neuroscience.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/UCL/rmcmc" class="external-link">rmcmc</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="hodgkin-huxley-model-for-action-potential-generation">Hodgkin-Huxley model for action potential generation<a class="anchor" aria-label="anchor" href="#hodgkin-huxley-model-for-action-potential-generation"></a>
</h2>
<p>We will use as an example a mathematical model describing how action
potentials in neurons are generated and how we might fit that model to
data. The <a href="https://en.wikipedia.org/wiki/Hodgkin%E2%80%93Huxley_model" class="external-link">model
of interest</a> was described by <span class="citation">Hodgkin and
Huxley (<a href="#ref-hodgkin1952currents">1952</a>)</span> based on
experimental investigations with squid giant axons. They received the
Nobel Prize in Physiology or Medicine for their work in 1963. We will
fit the model here to a digitisation of the data the original
experiments from <span class="citation">Daly et al. (<a href="#ref-daly2015hodgkin">2015</a>)</span>.</p>
<p>The <a href="https://en.wikipedia.org/wiki/Membrane_potential" class="external-link">cell
membrane voltage
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>V</mi><mi>m</mi></msub><annotation encoding="application/x-tex">V_m</annotation></semantics></math></a>
is modelled as being controlled by <a href="https://en.wikipedia.org/wiki/Voltage-gated_ion_channel" class="external-link">voltage-gated
ion channels</a>, with governing <a href="https://en.wikipedia.org/wiki/Ordinary_differential_equation" class="external-link">ordinary
differential equation (ODE)</a></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>m</mi></msub><mfrac><mrow><mi mathvariant="normal">d</mi><msub><mi>V</mi><mi>m</mi></msub></mrow><mrow><mi mathvariant="normal">d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><msub><mi>g</mi><mi>K</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>E</mi><mi>K</mi></msub><mo>âˆ’</mo><msub><mi>V</mi><mi>m</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>g</mi><mrow><mi>N</mi><mi>a</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>E</mi><mrow><mi>N</mi><mi>a</mi></mrow></msub><mo>âˆ’</mo><msub><mi>V</mi><mi>m</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><msub><mi>g</mi><mi>L</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>E</mi><mi>l</mi></msub><mo>âˆ’</mo><msub><mi>V</mi><mi>m</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mi>I</mi><mi>.</mi></mrow><annotation encoding="application/x-tex">
 C_m \frac{\mathrm{d}V_m}{\mathrm{d}t} = g_K (E_K - V_m) + g_{Na}(E_{Na} - V_m) + g_L(E_l - V_m) - I.
</annotation></semantics></math></p>
<p>where</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>C</mi><mi>m</mi></msub><annotation encoding="application/x-tex">C_m</annotation></semantics></math>
is the membrane capacitance per unit area,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mi>K</mi></msub><annotation encoding="application/x-tex">g_K</annotation></semantics></math>
is the potassium channel conductance,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mi>k</mi></msub><annotation encoding="application/x-tex">E_k</annotation></semantics></math>
the potassium channel reversal potential,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mrow><mi>N</mi><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">g_{Na}</annotation></semantics></math>
is the sodium channel conductance,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mrow><mi>N</mi><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">E_{Na}</annotation></semantics></math>
is the sodium channel reversal potential,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mi>L</mi></msub><annotation encoding="application/x-tex">g_L</annotation></semantics></math>
is the leakage conductance,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>E</mi><mi>L</mi></msub><annotation encoding="application/x-tex">E_L</annotation></semantics></math>
is the leakage reversal potential,</li>
<li>and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>I</mi><annotation encoding="application/x-tex">I</annotation></semantics></math>
is the membrane current per unit area.</li>
</ul>
<p>Importantly the potassium and sodium channel conductances,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mi>K</mi></msub><annotation encoding="application/x-tex">g_K</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mrow><mi>N</mi><mi>a</mi></mrow></msub><annotation encoding="application/x-tex">g_{Na}</annotation></semantics></math>,
are themselves time and voltage dependent variables. In Hodgkin and
Huxleyâ€™s experiments they used an ingenious <a href="https://en.wikipedia.org/wiki/Voltage_clamp" class="external-link">experimental
protocol</a> to allow measuring the evolution of the cell membraneâ€™s
conductance over time for specific ion channels while clamped to a
specific depolarization voltage. By varying the extracellular ion
concentrations, they were able to isolate the effects of the potassium
and sodium channels. Here we will concentrate on the model and data
specifically for
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mi>K</mi></msub><annotation encoding="application/x-tex">g_{K}</annotation></semantics></math>,
the potassium channel conductance.</p>
<p>The potassium channel conductance is modelled as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>g</mi><mtext mathvariant="normal">K</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mover><mi>g</mi><mo accent="true">â€¾</mo></mover><mtext mathvariant="normal">K</mtext></msub><mi>n</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mn>4</mn></msup><mo>,</mo></mrow><annotation encoding="application/x-tex">g_{\textrm{K}}(t, v, \theta) = \bar{g}_{\textrm{K}} n(t, v, \theta)^4,</annotation></semantics></math></p>
<p>where</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mover><mi>g</mi><mo accent="true">â€¾</mo></mover><mi>K</mi></msub><annotation encoding="application/x-tex">\bar{g}_K</annotation></semantics></math>
is the maximum potassium channel conductance,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
is a time and voltage dependent subunit activation probability in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math>,</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mo>=</mo><msub><mi>V</mi><mtext mathvariant="normal">rest</mtext></msub><mo>âˆ’</mo><msub><mi>V</mi><mi>m</mi></msub></mrow><annotation encoding="application/x-tex">v = V_{\text{rest}} - V_m</annotation></semantics></math>
is the depolarization from the resting potential
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>V</mi><mtext mathvariant="normal">rest</mtext></msub><annotation encoding="application/x-tex">V_{\text{rest}}</annotation></semantics></math>
in mV</li>
<li>and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¸</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mover><mi>g</mi><mo accent="true">â€¾</mo></mover><mi>K</mi></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>2</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>3</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>2</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\theta = (\bar{g}_K, k_{\alpha,1}, k_{\alpha, 2}, k_{\alpha, 3}, k_{\beta, 1}, k_{\beta,2})</annotation></semantics></math>
are a set of model parameters.</li>
</ul>
<p>The potassium channel subunit activation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
is governed by a linear ODE</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi mathvariant="normal">d</mi><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi mathvariant="normal">d</mi><mi>t</mi></mrow></mfrac><mo>=</mo><mfrac><mrow><msub><mi>n</mi><mi>âˆ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>Ï„</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{\mathrm{d} n(t, v, \theta)}{\mathrm{d} t} = \frac{n_\infty(v, \theta) - n(t, v, \theta)}{\tau(v, \theta)}</annotation></semantics></math></p>
<p>which has the analytic solution</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>,</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>n</mi><mi>âˆ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mi>n</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>âˆ’</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mo>âˆ’</mo><mi>t</mi><mi>/</mi><mi>Ï„</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
  n(t, v, \theta) = n(0, v, \theta) + \left(n_\infty(v, \theta) - n(0, v, \theta)\right) \left(1 - \exp(-t / \tau(v, \theta)) \right).
</annotation></semantics></math></p>
<p>The time constant
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Ï„</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>
and equilibrium value
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>n</mi><mi>âˆ</mi></msub><annotation encoding="application/x-tex">n_\infty</annotation></semantics></math>
are defined respectively in terms of rate constant functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Î±</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Ï„</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mrow><mi>Î±</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>Î²</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mo>,</mo><mspace width="1.0em"></mspace><msub><mi>n</mi><mi>âˆ</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mi>Î±</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mi>Î±</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>Î²</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac><mi>.</mi></mrow><annotation encoding="application/x-tex">
  \tau(v, \theta) = \frac{1}{\alpha(v, \theta) + \beta(v, \theta)},\quad
  n_\infty(v, \theta) = \frac{\alpha(v, \theta)}{\alpha(v, \theta) + \beta(v, \theta)}.
</annotation></semantics></math></p>
<p>The rate constants
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Î±</mi><annotation encoding="application/x-tex">\alpha</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Î²</mi><annotation encoding="application/x-tex">\beta</annotation></semantics></math>
are themselves defined respectively in terms of the model parameters
as</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î±</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>ğ›‰</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>1</mn></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>+</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>2</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>+</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>2</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>3</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>âˆ’</mo><mn>1</mn></mrow></mfrac><mo>,</mo><mspace width="1.0em"></mspace><mi>Î²</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mo>,</mo><mi>ğ›‰</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>v</mi><mi>/</mi><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>2</mn></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mrow><annotation encoding="application/x-tex">
  \alpha(v, \boldsymbol{\theta}) =  \frac{k_{\alpha, 1}(v + k_{\alpha, 2})}{\exp((v + k_{\alpha, 2}) / k_{\alpha, 3}) - 1},
  \quad
  \beta(v, \boldsymbol{\theta}) = k_{\beta, 1} \exp(v / k_{\beta, 2}).
</annotation></semantics></math></p>
<p>Together these equations define a mathematical model for how the
potassium conductance
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>g</mi><mi>K</mi></msub><annotation encoding="application/x-tex">g_K</annotation></semantics></math>
varies as a function of the applied depolarization and time, with six
unknown model parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Î¸</mi><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>2</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>3</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>2</mn></mrow></msub><mo>,</mo><msub><mover><mi>g</mi><mo accent="true">â€¾</mo></mover><mi>K</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\theta = (k_{\alpha,1}, k_{\alpha,2}, k_{\alpha,3}, k_{\beta,1}, k_{\beta,2}, \bar{g}_K)</annotation></semantics></math>
that need to be inferred from the experimental data. In Hodgkin and
Huxleyâ€™s experiments, the potassium conductances were measured at
regular time intervals for a series of applied depolarizations. We
assume here that the recorded conductances are subject to independent
zero-mean Gaussian noise with an unknown standard deviation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Ïƒ</mi><annotation encoding="application/x-tex">\sigma</annotation></semantics></math>,
that is</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>n</mi></msub><mo>âˆ¼</mo><mrow><mi>ğ–­</mi><mi>ğ—ˆ</mi><mi>ğ—‹</mi><mi>ğ—†</mi><mi>ğ–º</mi><mi>ğ—…</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>g</mi><mi>K</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>t</mi><mi>n</mi></msub><mo>,</mo><msub><mi>v</mi><mi>n</mi></msub><mo>,</mo><mi>Î¸</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mi>Ïƒ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="1.0em"></mspace><mo>âˆ€</mo><mi>n</mi><mo>âˆˆ</mo><mn>1</mn><mo>:</mo><mi>N</mi><mo>,</mo></mrow><annotation encoding="application/x-tex">
  y_{n} \sim \mathsf{Normal}(g_K(t_n, v_n, \theta), \sigma) \quad \forall n \in 1{:}N,
</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>t</mi><mi>n</mi></msub><annotation encoding="application/x-tex">t_n</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>v</mi><mi>n</mi></msub><annotation encoding="application/x-tex">v_n</annotation></semantics></math>
are the pairs of measurement times and applied depolarization voltages
for the measured potassium conductance
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>y</mi><mi>n</mi></msub><annotation encoding="application/x-tex">y_n</annotation></semantics></math>.</p>
<p>Altogether then we have seven parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>2</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>3</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>1</mn></mrow></msub><mo>,</mo><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>2</mn></mrow></msub><mo>,</mo><msub><mover><mi>g</mi><mo accent="true">â€¾</mo></mover><mi>K</mi></msub><mo>,</mo><mi>Ïƒ</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(k_{\alpha,1}, k_{\alpha,2}, k_{\alpha,3}, k_{\beta,1}, k_{\beta,2}, \bar{g}_K, \sigma)</annotation></semantics></math>
to infer. All parameters here are constrained to be non-negative. We
assume that they are apriori independent with weakly-informative log
normal prior distributions that correspond to beliefs about the typical
plausible magnitudes of these parameters:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mtable><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>âˆ¼</mo><mrow><mi>ğ–«</mi><mi>ğ—ˆ</mi><mi>ğ—€</mi><mi>ğ–­</mi><mi>ğ—ˆ</mi><mi>ğ—‹</mi><mi>ğ—†</mi><mi>ğ–º</mi><mi>ğ—…</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mo>âˆ’</mo><mn>3</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>2</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>âˆ¼</mo><mrow><mi>ğ–«</mi><mi>ğ—ˆ</mi><mi>ğ—€</mi><mi>ğ–­</mi><mi>ğ—ˆ</mi><mi>ğ—‹</mi><mi>ğ—†</mi><mi>ğ–º</mi><mi>ğ—…</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>k</mi><mrow><mi>Î±</mi><mo>,</mo><mn>3</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>âˆ¼</mo><mrow><mi>ğ–«</mi><mi>ğ—ˆ</mi><mi>ğ—€</mi><mi>ğ–­</mi><mi>ğ—ˆ</mi><mi>ğ—‹</mi><mi>ğ—†</mi><mi>ğ–º</mi><mi>ğ—…</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>1</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>âˆ¼</mo><mrow><mi>ğ–«</mi><mi>ğ—ˆ</mi><mi>ğ—€</mi><mi>ğ–­</mi><mi>ğ—ˆ</mi><mi>ğ—‹</mi><mi>ğ—†</mi><mi>ğ–º</mi><mi>ğ—…</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mo>âˆ’</mo><mn>3</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mi>k</mi><mrow><mi>Î²</mi><mo>,</mo><mn>2</mn></mrow></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>âˆ¼</mo><mrow><mi>ğ–«</mi><mi>ğ—ˆ</mi><mi>ğ—€</mi><mi>ğ–­</mi><mi>ğ—ˆ</mi><mi>ğ—‹</mi><mi>ğ—†</mi><mi>ğ–º</mi><mi>ğ—…</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><msub><mover><mi>g</mi><mo accent="true">â€¾</mo></mover><mi>K</mi></msub></mtd><mtd columnalign="left" style="text-align: left"><mo>âˆ¼</mo><mrow><mi>ğ–«</mi><mi>ğ—ˆ</mi><mi>ğ—€</mi><mi>ğ–­</mi><mi>ğ—ˆ</mi><mi>ğ—‹</mi><mi>ğ—†</mi><mi>ğ–º</mi><mi>ğ—…</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo></mtd></mtr><mtr><mtd columnalign="right" style="text-align: right"><mi>Ïƒ</mi></mtd><mtd columnalign="left" style="text-align: left"><mo>âˆ¼</mo><mrow><mi>ğ–«</mi><mi>ğ—ˆ</mi><mi>ğ—€</mi><mi>ğ–­</mi><mi>ğ—ˆ</mi><mi>ğ—‹</mi><mi>ğ—†</mi><mi>ğ–º</mi><mi>ğ—…</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mi>.</mi></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
  k_{\alpha,1} &amp;\sim \mathsf{LogNormal}(-3, 1),\\
  k_{\alpha,2} &amp;\sim \mathsf{LogNormal}(2, 1),\\
  k_{\alpha,3} &amp;\sim \mathsf{LogNormal}(2, 1),\\
  k_{\beta,1} &amp;\sim \mathsf{LogNormal}(-3, 1),\\
  k_{\beta,2} &amp;\sim \mathsf{LogNormal}(2, 1),\\
  \bar{g}_K &amp;\sim \mathsf{LogNormal}(2, 1),\\
  \sigma &amp;\sim \mathsf{LogNormal}(0, 1).
\end{aligned}
</annotation></semantics></math></p>
</div>
<div class="section level2">
<h2 id="stan-implementation">Stan implementation<a class="anchor" aria-label="anchor" href="#stan-implementation"></a>
</h2>
<p><a href="https://mc-stan.org/docs/reference-manual/" class="external-link">Stanâ€™s
high-level modelling syntax</a> makes it easy to translate the above
mathematical model to an efficient numerical implementation. Importantly
for our purposes, due to Stanâ€™s support for algorithmic differentiation,
we will be able to automatically compute derivatives for the resulting
model functions.</p>
<p>We first declare a series of <a href="https://mc-stan.org/docs/reference-manual/user-functions.html" class="external-link">user-defined
functions</a> in the <code>functions</code> block of a Stan model file,
corresponding to the various functions defined symbolically in the
previous section.</p>
<pre><code>functions {
  vector alpha_k(vector v, vector k_alpha) {
    return k_alpha[1] .* (v + k_alpha[2])
           ./ (exp((v + k_alpha[2]) ./ k_alpha[3]) - 1);
  }
  vector beta_k(vector v, vector k_beta) {
    return k_beta[1] .* exp(v ./ k_beta[2]);
  }
  vector n_infty(vector v, vector k_alpha, vector k_beta) {
    return alpha_k(v, k_alpha) ./ (alpha_k(v, k_alpha) + beta_k(v, k_beta));
  }
  vector tau_n(vector v, vector k_alpha, vector k_beta) {
    return 1 ./ (alpha_k(v, k_alpha) + beta_k(v, k_beta));
  }
  vector potassium_channel_subunit_activation(
    vector t, vector v, vector k_alpha, vector k_beta
  ) {
    real n_0 = n_infty([0.0]', k_alpha, k_beta)[1]; // Assume starting from equilibrium
    return n_0
           + (n_infty(v, k_alpha, k_beta) - n_0)
             .* (1 - exp(-t ./ tau_n(v, k_alpha, k_beta)));
  }
  vector potassium_conductance(
    vector t, vector v, real g_bar_k, vector k_alpha, vector k_beta, int N
  ) {
    vector[N] n = potassium_channel_subunit_activation(t, v, k_alpha, k_beta);
    return g_bar_k .* n .^ 4;
  }
}</code></pre>
<p>In <a href="https://mc-stan.org/docs/reference-manual/blocks.html#program-block-data" class="external-link">the
<code>data</code> block</a> we declare the names, types and dimensions
of the data values that will be read from the passed data file. Here the
data consists of three one-dimensional arrays (vectors) each of length
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>136</mn></mrow><annotation encoding="application/x-tex">N = 136</annotation></semantics></math>,
corresponding to the measurement times (<code>times</code>, unit
<em>ms</em>), depolarizations applied to the axons
(<code>depolarizations</code>, unit <em>mV</em>) and measured
conductances (<code>conductances</code>, unit <em>mS cm^{-1}</em>).</p>
<pre><code>data {
  int&lt;lower=1&gt; N;
  vector[N] times;
  vector[N] depolarizations;
  vector[N] conductances;
}</code></pre>
<p>In <a href="https://mc-stan.org/docs/reference-manual/blocks.html#program-block-parameters" class="external-link">the
<code>parameter</code> block</a> we declare the name, types, dimensions
and any constraints on the model parameters that we will be inferring.
Here the rate constant parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>k</mi><mi>Î±</mi></msub><annotation encoding="application/x-tex">k_{\alpha}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>k</mi><mi>Î²</mi></msub><annotation encoding="application/x-tex">k_{\beta}</annotation></semantics></math>
are declared as vectors of dimension 3 and 2 respectively. All
parameters here are non-negative and so a <code>lower=0</code>
constraint is added to indicate to Stan to <a href="https://mc-stan.org/docs/reference-manual/transforms.html" class="external-link">transform
these constrained parameters to an unconstrained representation suitable
for sampling</a>.</p>
<pre><code>parameters {
  vector&lt;lower=0&gt;[3] k_alpha;
  vector&lt;lower=0&gt;[2] k_beta;
  real&lt;lower=0&gt; g_bar_k;
  real&lt;lower=0&gt; sigma;
}</code></pre>
<p>We are now ready to put everything together in <a href="https://mc-stan.org/docs/reference-manual/blocks.html#program-block-model" class="external-link">the
<code>model</code> block</a>. We first define the log-normal prior
distributions on all the model parameters. We then call the earlier
defined <code>potassium_conductance</code> function to compute the
simulated potassium conductance values given the measurement times and
depolarizations from the data and parameter values. Finally we specify
that the observed conductance values are subject to independent normal
observation noise.</p>
<pre><code>model {
  //priors
  k_alpha[1] ~ lognormal(-3, 1);
  k_alpha[2] ~ lognormal(2, 1);
  k_alpha[3] ~ lognormal(2, 1);
  k_beta[1] ~ lognormal(-3, 1);
  k_beta[2] ~ lognormal(2, 1);
  g_bar_k ~ lognormal(2, 1);
  sigma ~ lognormal(0, 1);
  // Solve model to simulate conductances
  vector[N] simulated_conductances = potassium_conductance(
    times, depolarizations, g_bar_k, k_alpha, k_beta, N
  );
  // likelihood
  conductances ~ normal(simulated_conductances, sigma);
}</code></pre>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>The data we will use to fit the model is a from a digitisation of the
experimental data from <span class="citation">Hodgkin and Huxley (<a href="#ref-hodgkin1952currents">1952</a>)</span> due to <span class="citation">Daly et al. (<a href="#ref-daly2015hodgkin">2015</a>)</span>. The data has been written
in JSON format to a file
<code>hodgkin-huxley-potassium-data.json</code>, with contents</p>
<pre><code>{
  "N": 136,
  "times": [
        0.151969,  0.346818,  0.540928,  0.708482,  1.08186 ,  1.48128 ,
        1.94706 ,  2.77638 ,  4.08767 ,  6.38795 ,  8.74094 ,  0.143946,
        0.351982,  0.546323,  0.727155,  1.08817 ,  1.50074 ,  1.96633 ,
        2.78252 ,  4.14563 ,  6.41981 ,  8.79894 ,  0.166009,  0.360627,
        0.564685,  0.719812,  1.10767 ,  1.51457 ,  1.98016 ,  2.79612 ,
        4.14918 ,  6.43957 ,  8.78951 , 11.2179  ,  0.181155,  0.38587 ,
        0.570391,  0.745402,  1.12413 ,  1.51208 ,  1.9878  ,  2.81355 ,
        4.15654 ,  6.40831 ,  8.79632 , 11.2246  ,  0.176417,  0.390884,
        0.575647,  0.750935,  1.12043 ,  1.52861 ,  1.99489 ,  2.8308  ,
        4.17366 ,  6.44379 ,  8.80331 , 11.2411  ,  0.189592,  0.384833,
        0.569941,  0.754981,  1.1346  ,  1.54314 ,  1.99071 ,  2.81711 ,
        4.16031 ,  6.42045 ,  8.79916 , 11.2174  , 11.9878  ,  0.192635,
        0.387599,  0.582563,  0.758058,  1.11856 ,  1.53733 ,  2.00485 ,
        2.8225  ,  4.15637 ,  6.4459  ,  8.81437 , 11.2423  , 12.0029  ,
        0.185443,  0.351221,  0.565688,  0.750969,  1.16043 ,  1.56976 ,
        1.99835 ,  2.84581 ,  4.18023 ,  6.45033 ,  8.82848 , 11.2172  ,
       11.9973  ,  0.187172,  0.362701,  0.567555,  0.77234 ,  1.12336 ,
        1.5522  ,  2.01038 ,  2.81901 ,  4.17345 ,  6.46347 ,  8.83215 ,
       11.2404  , 12.0104  ,  0.189039,  0.345169,  0.579174,  0.774242,
        1.12527 ,  1.58342 ,  2.02211 ,  2.84087 ,  4.18601 ,  6.43774 ,
        8.83581 , 11.2438  , 12.0042  ,  0.174412,  0.320652,  0.583981,
        0.749621,  1.12018 ,  1.51018 ,  2.00731 ,  2.84564 ,  4.19074 ,
        6.41301 ,  8.83059 , 11.2483  , 11.9989
  ],
  "depolarizations": [
       -109.0  , -109.0 , -109.0 , -109.0 , -109.0  , -109.0  , -109.0  ,
       -109.0  , -109.0  , -109.0  , -109.0  , -100.0  , -100.0  , -100.0  ,
       -100.0  , -100.0  , -100.0  , -100.0  , -100.0  , -100.0  , -100.0  ,
       -100.0  ,  -88.0  ,  -88.0  ,  -88.0  ,  -88.0  ,  -88.0  ,  -88.0  ,
        -88.0  ,  -88.0  ,  -88.0  ,  -88.0  ,  -88.0  ,  -88.0  ,  -76.0  ,
        -76.0  ,  -76.0  ,  -76.0  ,  -76.0  ,  -76.0  ,  -76.0  ,  -76.0  ,
        -76.0  ,  -76.0  ,  -76.0  ,  -76.0  ,  -63.0  ,  -63.0  ,  -63.0  ,
        -63.0  ,  -63.0  ,  -63.0  ,  -63.0  ,  -63.0  ,  -63.0  ,  -63.0  ,
        -63.0  ,  -63.0  ,  -51.0  ,  -51.0  ,  -51.0  ,  -51.0  ,  -51.0  ,
        -51.0  ,  -51.0  ,  -51.0  ,  -51.0  ,  -51.0  ,  -51.0  ,  -51.0  ,
        -51.0  ,  -38.0  ,  -38.0  ,  -38.0  ,  -38.0  ,  -38.0  ,  -38.0  ,
        -38.0  ,  -38.0  ,  -38.0  ,  -38.0  ,  -38.0  ,  -38.0  ,  -38.0  ,
        -32.0  ,  -32.0  ,  -32.0  ,  -32.0  ,  -32.0  ,  -32.0  ,  -32.0  ,
        -32.0  ,  -32.0  ,  -32.0  ,  -32.0  ,  -32.0  ,  -32.0  ,  -26.0  ,
        -26.0  ,  -26.0  ,  -26.0  ,  -26.0  ,  -26.0  ,  -26.0  ,  -26.0  ,
        -26.0  ,  -26.0  ,  -26.0  ,  -26.0  ,  -26.0  ,  -19.0  ,  -19.0  ,
        -19.0  ,  -19.0  ,  -19.0  ,  -19.0  ,  -19.0  ,  -19.0  ,  -19.0  ,
        -19.0  ,  -19.0  ,  -19.0  ,  -19.0  ,  -10.01,  -10.01,  -10.01,
        -10.01,  -10.01,  -10.01,  -10.01,  -10.01,  -10.01,  -10.01,
        -10.01,  -10.01,  -10.01
  ],
  "conductances": [
        0.26035 ,  0.469177,  1.50235 ,  3.15343 ,  7.28047 , 11.3564  ,
       13.939   , 17.0936  , 19.2759  , 20.5448  , 21.0415  ,  0.7394  ,
        0.742386,  1.5346  ,  2.90553 ,  6.38418 , 10.3899  , 13.2385  ,
       16.6184  , 19.0589  , 20.4598  , 20.8098  ,  0.25768 ,  0.719578,
        1.526   ,  2.52307 ,  4.97748 ,  7.9296  , 10.6912  , 14.223   ,
       16.9205  , 18.3299  , 18.5922  , 18.3581  ,  0.196537,  0.276938,
        1.13222 ,  1.71605 ,  3.50426 ,  5.87397 ,  8.24492 , 11.7835  ,
       14.8643  , 15.865   , 17.1777  , 17.0957  ,  0.514338,  0.596152,
        1.18937 ,  1.46748 ,  2.6933  ,  4.27401 ,  6.32801 ,  9.45034 ,
       12.7374  , 15.0535  , 15.5203  , 15.6734  ,  0.72418 ,  0.499035,
        0.691458,  0.959828,  1.72454 ,  2.86938 ,  3.97679 ,  6.72229 ,
        9.5129  , 12.0124  , 12.8047  , 13.0659  , 13.0006  ,  0.342299,
        0.420447,  0.498595,  0.538739,  0.883313,  1.49284 ,  2.10304 ,
        3.73692 ,  6.05714 ,  8.39047 ,  9.70601 , 10.0035  , 10.0517  ,
        0.394772,  0.397135,  0.478621,  0.481263,  0.604742,  0.885073,
        1.44017 ,  2.51102 ,  4.29465 ,  6.64062 ,  8.08621 ,  8.59084 ,
        8.68039 ,  0.482695,  0.485248,  0.408227,  0.411206,  0.456312,
        0.742553,  0.90922 ,  1.80099 ,  3.02071 ,  4.93404 ,  6.08851 ,
        6.64355 ,  7.05475 ,  0.410034,  0.301024,  0.341214,  0.306803,
        0.348568,  0.539926,  0.693985,  1.11242 ,  1.76018 ,  2.75348 ,
        3.67468 ,  4.37379 ,  4.71736 ,  0.243338,  0.253563,  0.244784,
        0.284204,  0.285513,  0.306307,  0.366316,  0.456655,  0.636163,
        0.954693,  1.19624 ,  1.38924 ,  1.47927
  ]
}</code></pre>
<p>Using the <code>rjson</code> and <code>ggplot2</code> package we can
visualize this conductance data.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/alexcb/rjson" class="external-link">rjson</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>We first read the data from the JSON file in to a data frame.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/rjson/man/fromJSON.html" class="external-link">fromJSON</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"hodgkin-huxley-potassium-data.json"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then plot the conductances against measurement times, grouping by
the depolarization level with a different colour for each level.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">times</span>, y <span class="op">=</span> <span class="va">conductances</span>, colour <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">depolarizations</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="st">"Times / ms"</span>, y <span class="op">=</span> <span class="st">"Conductances / mS cm-2"</span>, colour <span class="op">=</span> <span class="st">"Depolarizations / mV"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="interfacing-with-stan-models_files/figure-html/unnamed-chunk-9-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="fitting-model-with-rmcmc">Fitting model with <code>rmcmc</code><a class="anchor" aria-label="anchor" href="#fitting-model-with-rmcmc"></a>
</h2>
<p>We are now ready to sample from the modelâ€™s posterior distribution
using <code>rmcmc</code>. We will use BridgeStan to construct a
<code>StanModel</code> object from the files defining the Stan model and
data.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">bridgestan</span><span class="op">)</span></span></code></pre></div>
<p>Before creating the model object, we set a fixed random seed and use
it to seed the global R random number generator state. We will also use
this seed for the (separate) random number generator state used by
BridgeStan.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seed</span> <span class="op">&lt;-</span> <span class="fl">7861223L</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span></span></code></pre></div>
<p>We now create our model object, passing the paths to the Stan model
file and JSON data file respectively, as well as our integer seed for
the internal Stan random number generator state.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model</span> <span class="op">&lt;-</span> <span class="va"><a href="https://rdrr.io/pkg/bridgestan/man/StanModel.html" class="external-link">StanModel</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>  <span class="st">"hodgkin-huxley-potassium-model.stan"</span>,</span>
<span>  <span class="st">"hodgkin-huxley-potassium-data.json"</span>,</span>
<span>  <span class="va">seed</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code>rmcmc</code> requires the initial chain state to be explicitly
specified. The <code>StanModel</code> object we just created includes a
method <code>param_unc_num</code> which can be used to evaluate the
dimension of the unconstrained model parameter space we will perform
inference in. Here we use the arbitrary choice of initializing with
random uniform values on (0, 1) in the unconstrained space.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">model</span><span class="op">$</span><span class="fu">param_unc_num</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now have all the components we need to sample a chain using
<code>rmcmc</code>. The <code><a href="../reference/sample_chain.html">sample_chain()</a></code> function is the main
entry point to <code>rmcmc</code>. It takes several arguments, one of
the most important of which is the <code>target_distribution</code>
specifying the distribution to generate approximate samples for. This
can be supplied in various formats; here we will exploit the ability to
pass a BridgeStan <code>StanModel</code> instance directly, with this
internally be mapped through the
<code><a href="../reference/target_distribution_from_stan_model.html">target_distribution_from_stan_model()</a></code> function. This
function can be called explicitly for additional control, for example
customizing whether values defined in the Stan generated quantities or
transformed parameters blocks are included in the traced chain
outputs.</p>
<p>We also pass our sampled initial state and specify to use 100000
iterations for both the initial adaptive warm-up and main (non-adaptive)
sampling stages. A chain of this length takes around a minute to sample
on a laptop. Finally we here explicitly specify the adaptation scheme
used to learn the proposal scale and shape parameters. This overrides
the default choice of using a dense shape matrix based on the estimated
covariances, to instead use a diagonal shape matrix based on just the
estimated variances. This was found to give robuster sampling in
practice here.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_chain.html">sample_chain</a></span><span class="op">(</span></span>
<span>  target_distribution <span class="op">=</span> <span class="va">model</span>,</span>
<span>  initial_state <span class="op">=</span> <span class="va">initial_state</span>,</span>
<span>  n_warm_up_iteration <span class="op">=</span> <span class="fl">100000</span>,</span>
<span>  n_main_iteration <span class="op">=</span> <span class="fl">100000</span>,</span>
<span>  adapters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/scale_adapter.html">scale_adapter</a></span><span class="op">(</span><span class="op">)</span>, <span class="fu"><a href="../reference/shape_adapter.html">shape_adapter</a></span><span class="op">(</span><span class="st">"variance"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="checking-results-with-posterior">Checking results with <code>posterior</code><a class="anchor" aria-label="anchor" href="#checking-results-with-posterior"></a>
</h2>
<p>We can use the <code>posterior</code> package to compute summary
statistics and convergence diagnostics for the sampled chain.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is posterior version 1.6.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'posterior'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     mad, sd, var</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     %in%, match</span></span></code></pre></div>
<p>While the <code>results$traces</code> matrix (with rows corresponding
to the chain iterations and column the traced variables) can be passed
directly to main of the functions in the <code>posterior</code> package,
here we will explicitly create a draws object to allow using some of the
functions for subsetting the draws.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws.html" class="external-link">as_draws</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">traces</span><span class="op">)</span></span></code></pre></div>
<p>We first compute and display a series of convergence diagnostics,
using the <code>subset_draws</code> function in posterior to filter only
the traced variables corresponding to the model parameters (accessed
using the <code>model$param_names()</code> method):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">summarize_draws</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/posterior/reference/subset_draws.html" class="external-link">subset_draws</a></span><span class="op">(</span><span class="va">draws</span>, <span class="va">model</span><span class="op">$</span><span class="fu">param_names</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">default_convergence_measures</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 Ã— 4</span></span></span>
<span><span class="co">#&gt;   variable   rhat ess_bulk ess_tail</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> k_alpha.1  1.01    187.     498. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> k_alpha.2  1.01     52.7     88.7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> k_alpha.3  1.01    164.     386. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> k_beta.1   1.00    163.     255. </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> k_beta.2   1.01     34.6     81.4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> g_bar_k    1.02     40.6     87.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> sigma      1.01    231.     583.</span></span></code></pre></div>
<p>The rank-normalized
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>R</mi><mo accent="true">Ì‚</mo></mover><annotation encoding="application/x-tex">\hat{R}</annotation></semantics></math>
values are all close to 1 which is indicative of the chain having
converged, though note as we have only sampled a single chain here the
power of this diagnostic is limited. The effective sample size (ESS)
estimates for both the bulk and tail are on the low side, but suggest we
should be able to compute reasonably informative posterior
estimates.</p>
<p>We can also compute summary statistics for the posterior distribution
on the model parameters:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">summarize_draws</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/subset_draws.html" class="external-link">subset_draws</a></span><span class="op">(</span><span class="va">draws</span>, <span class="va">model</span><span class="op">$</span><span class="fu">param_names</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">default_summary_measures</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 7 Ã— 7</span></span></span>
<span><span class="co">#&gt;   variable       mean    median         sd        mad        q5       q95</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> k_alpha.1   0.009<span style="text-decoration: underline;">28</span>   0.009<span style="text-decoration: underline;">27</span>   0.000<span style="text-decoration: underline;">184</span>   0.000<span style="text-decoration: underline;">189</span>   0.008<span style="text-decoration: underline;">98</span>   0.009<span style="text-decoration: underline;">58</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> k_alpha.2   0.756     0.687     0.379      0.344      0.268     1.45   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> k_alpha.3   3.51      3.51      0.297      0.296      3.04      4.02   </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> k_beta.1    0.107     0.107     0.003<span style="text-decoration: underline;">19</span>    0.003<span style="text-decoration: underline;">08</span>    0.102     0.112  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> k_beta.2  362.      334.      138.       101.       208.      618.     </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> g_bar_k    27.5      27.5       0.858      0.831     26.1      28.9    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">7</span> sigma       0.350     0.348     0.022<span style="text-decoration: underline;">8</span>     0.022<span style="text-decoration: underline;">5</span>     0.316     0.390</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="visualising-posterior-with-bayesplot">Visualising posterior with <code>bayesplot</code><a class="anchor" aria-label="anchor" href="#visualising-posterior-with-bayesplot"></a>
</h2>
<p>As well as being able to compute diagnostics and statistics using the
<code>posterior</code> package, the sampled chain can also be visualized
using the <code>bayesplot</code> package.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is bayesplot version 1.14.0</span></span>
<span><span class="co">#&gt; - Online documentation and vignettes at mc-stan.org/bayesplot</span></span>
<span><span class="co">#&gt; - bayesplot theme set to bayesplot::theme_default()</span></span>
<span><span class="co">#&gt;    * Does _not_ affect other ggplot2 plots</span></span>
<span><span class="co">#&gt;    * See ?bayesplot_theme_set for details on theme setting</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'bayesplot'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:posterior':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     rhat</span></span></code></pre></div>
<p>For example, we can plot a pair plot of the univariate and bivariate
marginal posterior distributions on the parameters as follows:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-scatterplots.html" class="external-link">mcmc_pairs</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://mc-stan.org/posterior/reference/thin_draws.html" class="external-link">thin_draws</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/subset_draws.html" class="external-link">subset_draws</a></span><span class="op">(</span><span class="va">draws</span>, <span class="va">model</span><span class="op">$</span><span class="fu">param_names</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  diag_fun <span class="op">=</span> <span class="st">"dens"</span>,</span>
<span>  off_diag_fun <span class="op">=</span> <span class="st">"hex"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Only one chain in 'x'. This plot is more useful with multiple chains.</span></span></code></pre></div>
<p><img src="interfacing-with-stan-models_files/figure-html/unnamed-chunk-20-1.png" width="960"></p>
<p>Here we use the <code>thin_draws</code> function from the
<code>posterior</code> package to thin the draws by a factor of 10 to
reduce the number of points needing to be binned in the plots. This
reduces the time required to produce to plot while having minimal effect
on the variances of the plotted densities.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-daly2015hodgkin" class="csl-entry">
Daly, Aidan C, David J Gavaghan, Chris Holmes, and Jonathan Cooper.
2015. <span>â€œ<span>Hodgkinâ€“Huxley</span> Revisited: Reparametrization
and Identifiability Analysis of the Classic Action Potential Model with
Approximate <span>B</span>ayesian Methods.â€</span> <em>Royal Society
Open Science</em> 2 (12): 150499.
</div>
<div id="ref-hodgkin1952currents" class="csl-entry">
Hodgkin, Allan L, and Andrew F Huxley. 1952. <span>â€œCurrents Carried by
Sodium and Potassium Ions Through the Membrane of the Giant Axon of
<span>L</span>oligo.â€</span> <em>The Journal of Physiology</em> 116 (4):
449.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew M. Graham, Samuel Livingstone, Engineering and Physical Sciences Research Council.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>

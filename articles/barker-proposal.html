<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Robust gradient-based MCMC with the Barker proposal • rmcmc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Robust gradient-based MCMC with the Barker proposal">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rmcmc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/adjusting-noise-distribution.html">Adjusting the noise distribution in the Barker proposal</a></li>
    <li><a class="dropdown-item" href="../articles/barker-proposal.html">Robust gradient-based MCMC with the Barker proposal</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UCL/rmcmc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Robust gradient-based MCMC with the Barker proposal</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/UCL/rmcmc/blob/v0.1.1/vignettes/barker-proposal.Rmd" class="external-link"><code>vignettes/barker-proposal.Rmd</code></a></small>
      <div class="d-none name"><code>barker-proposal.Rmd</code></div>
    </div>

    
    
<p>The <code>rmcmc</code> package provides a general-purpose
implementation of the Barker proposal <span class="citation">(<a href="#ref-barker1965monte">Barker 1965</a>)</span>, a gradient-based
Markov chain Monte Carlo (MCMC) algorithm inspired by the Barker
accept-reject rule, proposed by <span class="citation">Livingstone and
Zanella (<a href="#ref-livingstone2022barker">2022</a>)</span>. This
vignette demonstrates how to use the package to sample Markov chains
from a target distribution of interest, and illustrates the robustness
to tuning that is a key advantage of the Barker proposal compared to
alternatives such as the Metropolis adjusted Langevin algorithm
(MALA).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/UCL/rmcmc" class="external-link">rmcmc</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="example-target-distribution">Example target distribution<a class="anchor" aria-label="anchor" href="#example-target-distribution"></a>
</h2>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dimension</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">scales</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">dimension</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>As a simple example of a target distribution, we consider a
10-dimensional Gaussian target with heterogeneous scales such that the
standard deviation of the first coordinate is 0.01 and that of other
coordinates is 1. The <code>rmcmc</code> package expects the target
distribution to be specified by a function evaluating the logarithm of
the (potentially unnormalized) probability density at a point, and for
gradient-based methods such as the Barker proposal, additionally
requires specification of a function evaluating the gradient of this log
density function. The two functions should be wrapped in to a list under
the names <code>log_density</code> and <code>gradient_log_density</code>
respectively.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">target_distribution</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  log_density <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">/</span> <span class="va">scales</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>  gradient_log_density <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="va">x</span> <span class="op">/</span> <span class="va">scales</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-proposal-distribution">Creating proposal distribution<a class="anchor" aria-label="anchor" href="#creating-proposal-distribution"></a>
</h2>
<p><code>rmcmc</code> provides implementations of several different
proposal distributions which can be used within a Metropolis–Hastings
based MCMC method:</p>
<ul>
<li>
<code><a href="../reference/barker_proposal.html">barker_proposal()</a></code>: The robust gradient-based Barker
proposal proposed by <span class="citation">Livingstone and Zanella (<a href="#ref-livingstone2022barker">2022</a>)</span>.</li>
<li>
<code><a href="../reference/langevin_proposal.html">langevin_proposal()</a></code>: A gradient-based proposal based on
a discretization of Langevin dynamics.</li>
<li>
<code><a href="../reference/hamiltonian_proposal.html">hamiltonian_proposal()</a></code>: A gradient-based proposal based
on a discretization of Hamiltonian dynamics, simulated for a fixed
number of integrator steps. With a single integrator step equivalent to
<code>langevin_proposal</code>.</li>
<li>
<code><a href="../reference/random_walk_proposal.html">random_walk_proposal()</a></code>: A Gaussian random-walk
proposal.</li>
</ul>
<p>Each function takes optional arguments which can be used to customize
the behaviour of the proposal such as the scalar <code>scale</code> of
the proposal, a vector or matrix defining the proposal
<code>shape</code> and routines to sample the auxiliary variables used
in the proposal.</p>
<p>Here we create an instance of the Barker proposal, using the default
values of all arguments. Rather than specifying fixed <code>scale</code>
and <code>shape</code> tuning parameters, in the next section we
illustrate how to set up adaptation of these parameters during a warm-up
stage to the chains.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">proposal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/barker_proposal.html">barker_proposal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setting-up-adaptation-of-tuning-parameters">Setting up adaptation of tuning parameters<a class="anchor" aria-label="anchor" href="#setting-up-adaptation-of-tuning-parameters"></a>
</h2>
<p><code>rmcmc</code> has support for adaptively tuning parameters of
the proposal distribution. This is mediated by ‘adapter’ objects which
define method for update the parameters of a proposal based on the chain
state and statistics recorded during a chain iteration. Below we
instantiate a list of adapters to (i) adapt the scalar scale of the
proposal distribution to coerce the average acceptance probability of
the chain transitions to a target value, and (ii) adapt the shape of the
proposal distribution with per-coordinate scaling factors based on
estimates on the coordinate-wise variances under the target
distribution.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adapters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/scale_adapter.html">scale_adapter</a></span><span class="op">(</span></span>
<span>    algorithm <span class="op">=</span> <span class="st">"stochastic_approximation"</span>,</span>
<span>    initial_scale <span class="op">=</span> <span class="va">dimension</span><span class="op">^</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">6</span><span class="op">)</span>,</span>
<span>    target_accept_prob <span class="op">=</span> <span class="fl">0.574</span>,</span>
<span>    kappa <span class="op">=</span> <span class="fl">0.6</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/shape_adapter.html">shape_adapter</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"variance"</span>, kappa <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here we set the initial scale to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>𝒪</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mtext mathvariant="normal">dimension</mtext><mrow><mo>−</mo><mfrac><mn>1</mn><mn>6</mn></mfrac></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{O}(\text{dimension}^{-\frac{1}{6}})</annotation></semantics></math>
and the target acceptance probability to 0.574 following the guidelines
in <span class="citation">Vogrinc, Livingstone, and Zanella (<a href="#ref-vogrinc2023optimal">2023</a>)</span>. This is equivalent to
the default behaviour when not specifying the <code>initial_scale</code>
and <code>target_accept_prob</code> arguments, in which case proposal
and dimension dependent values following the guidelines in <span class="citation">Vogrinc, Livingstone, and Zanella (<a href="#ref-vogrinc2023optimal">2023</a>)</span> will be used. Both
adapters have an optional <code>kappa</code> argument which can be used
to set the decay rate exponent for the adaptation learning rate. We set
this to 0.6, following the recommendation in <span class="citation">Livingstone and Zanella (<a href="#ref-livingstone2022barker">2022</a>)</span>, in both cases.</p>
<p>The adapter updates will be applied only during an initial set of
‘warm-up’ chain iterations, with the proposal parameters remaining fixed
to their final adapted values during a subsequent set of main chain
iterations.</p>
</div>
<div class="section level2">
<h2 id="sampling-a-chain">Sampling a chain<a class="anchor" aria-label="anchor" href="#sampling-a-chain"></a>
</h2>
<p>To sample a chain we first need to specify the initial chain state.
The <code>rmcmc</code> package encapsulates the chain state in a list
which tracks the current position of the chain, but also additional
quantities such as the auxiliary variables used to generate the proposed
perturbation to the state, and cached values of the log density and its
gradient once computed once at the current position to avoid
re-computation. The [chain_state()] function allows creation of a list
of the required format, with the first (and only required) argument
specifying the position. Alternatively we can directly pass a vector
specifying just the position component of the state to the
<code>initial_state</code> argument of [sample_chain()]. Here we
generate an initial state with position coordinates sampled from a
independent normal distributions with standard deviation 10, following
the example in <span class="citation">Livingstone and Zanella (<a href="#ref-livingstone2022barker">2022</a>)</span>. For reproducibility
we also fix the random seed.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">791285301L</span><span class="op">)</span></span>
<span><span class="va">initial_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chain_state.html">chain_state</a></span><span class="op">(</span><span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now have everything needed to sample a Markov chain. To do this we
use the <code>sample_chain</code> function from <code>rmcmc</code>. This
requires us to specify the target distribution, proposal distribution,
initial chain state, number of adaptive warm-up iterations and
non-adaptive main chain iterations and list of adapters to use.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_warm_up_iteration</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span>
<span><span class="va">n_main_iteration</span> <span class="op">&lt;-</span> <span class="fl">10000</span></span></code></pre></div>
<p>Here we sample a chain with
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mn>4</mn></msup><annotation encoding="application/x-tex">10^{4}</annotation></semantics></math>
warm-up and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mn>10</mn><mn>4</mn></msup><annotation encoding="application/x-tex">10^{4}</annotation></semantics></math>
main chain iterations. We set <code>trace_warm_up</code> to
<code>TRUE</code> to record statistics during the adaptive warm-up chain
iterations.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">barker_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_chain.html">sample_chain</a></span><span class="op">(</span></span>
<span>  target_distribution <span class="op">=</span> <span class="va">target_distribution</span>,</span>
<span>  proposal <span class="op">=</span> <span class="va">proposal</span>,</span>
<span>  initial_state <span class="op">=</span> <span class="va">initial_state</span>,</span>
<span>  n_warm_up_iteration <span class="op">=</span> <span class="va">n_warm_up_iteration</span>,</span>
<span>  n_main_iteration <span class="op">=</span> <span class="va">n_main_iteration</span>,</span>
<span>  adapters <span class="op">=</span> <span class="va">adapters</span>,</span>
<span>  trace_warm_up <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If the <code>progress</code> package is installed a progress bar will
show the chain progress during sampling. The return value of
<code>sample_chains</code> is a list containing fields for accessing the
final chain state (which can be used to start sampling a new chain), any
variables traced during the main chain iterations and any additional
statistics recorded during the main chain iterations. If the
<code>trace_warm_up</code> argument to <code>sample_chains</code> is set
to <code>TRUE</code> as above, then the list returned by
<code>sample_chains</code> will also contain entries
<code>warm_up_traces</code> and <code>warm_up_statistics</code>
corresponding to respectively the variable traces and additional
statistics recorded during the warm-up iterations.</p>
<p>One of the additional statistics recorded is the acceptance
probability for each chain iteration under the name
<code>accept_prob</code>. We can therefore compute the mean acceptance
probability of the main chain iterations as follows:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_accept_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">barker_results</span><span class="op">$</span><span class="va">statistics</span><span class="op">[</span>, <span class="st">"accept_prob"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Average acceptance probability is %.2f"</span>, <span class="va">mean_accept_prob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Average acceptance probability is 0.54</span></span></code></pre></div>
<p>This is close to the target acceptance rate of 0.574 indicating the
scale adaptation worked as expected.</p>
<p>We can also inspect the shape parameter of the proposal to check the
variance based shape adaptation succeeded. The below snippet extracts
the (first few dimensions of the) adapted shape from the
<code>proposal</code> object and compares to the known true scales
(per-coordinate standard deviations) of the target distribution.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clipped_dimension</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">5</span>, <span class="va">dimension</span><span class="op">)</span></span>
<span><span class="va">final_shape</span> <span class="op">&lt;-</span> <span class="va">proposal</span><span class="op">$</span><span class="fu">parameters</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">shape</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Adapter scale est.: %s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/toString.html" class="external-link">toString</a></span><span class="op">(</span><span class="va">final_shape</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">clipped_dimension</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"True target scales: %s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/toString.html" class="external-link">toString</a></span><span class="op">(</span><span class="va">scales</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">clipped_dimension</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sep <span class="op">=</span> <span class="st">"\n"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Adapter scale est.: 0.00922080029766185, 0.995077611400515, 0.975164196791254, 0.938742004951002, 0.959131700160353</span></span>
<span><span class="co">#&gt; True target scales: 0.01, 1, 1, 1, 1</span></span></code></pre></div>
<p>Again adaptation appears to have been successful with the adapted
shape close to the true target scales.</p>
</div>
<div class="section level2">
<h2 id="summarizing-results-using-posterior-package">Summarizing results using <code>posterior</code> package<a class="anchor" aria-label="anchor" href="#summarizing-results-using-posterior-package"></a>
</h2>
<p>The output from <code>sample_chains</code> can also be easily used
with external packages for analyzing MCMC outputs. For example the <a href="https://mc-stan.org/posterior/index.html" class="external-link"><code>posterior</code>
package</a> provides implementations of various inference diagnostic and
functions for manipulating, subsetting and summarizing MCMC outputs.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; This is posterior version 1.6.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'posterior'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     mad, sd, var</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     %in%, match</span></span></code></pre></div>
<p>The <code>traces</code> entry in the returned (list) output from
<code>sample_chain</code> is a matrix with row corresponding to the
chain iterations and (named) columns the traced variables. This matrix
can be directly coerced to the <code>draws</code> data format the
<code>posterior</code> package internally uses to represent chain
outputs, and so can be passed directly to the <a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link"><code>summarize_draws</code>
function</a> to output a <code>tibble</code> data frame containing a set
of summary statistics and diagnostic measures for each variable.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">summarize_draws</a></span><span class="op">(</span><span class="va">barker_results</span><span class="op">$</span><span class="va">traces</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11 × 10</span></span></span>
<span><span class="co">#&gt;    variable           mean   median     sd    mad      q5     q95  rhat ess_bulk</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> position1       1.63<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  3.51<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> 0.010<span style="text-decoration: underline;">2</span> 0.010<span style="text-decoration: underline;">4</span> -<span style="color: #BB0000;">0.016</span><span style="color: #BB0000; text-decoration: underline;">6</span>  0.016<span style="text-decoration: underline;">9</span>  1.00    <span style="text-decoration: underline;">1</span>197.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> position2      -<span style="color: #BB0000;">3.07</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">9.21</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 1.01   0.990  -<span style="color: #BB0000;">1.72</span>    1.62    1.00    <span style="text-decoration: underline;">1</span>405.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> position3       2.22<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  1.54<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.01   1.01   -<span style="color: #BB0000;">1.61</span>    1.64    1.00    <span style="text-decoration: underline;">1</span>191.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> position4       2.13<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  1.25<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.02   1.04   -<span style="color: #BB0000;">1.68</span>    1.68    1.00    <span style="text-decoration: underline;">1</span>250.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> position5       1.78<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  2.02<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 0.993  1.01   -<span style="color: #BB0000;">1.63</span>    1.62    1.00    <span style="text-decoration: underline;">1</span>370.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> position6      -<span style="color: #BB0000;">2.23</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">3.13</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.01   0.996  -<span style="color: #BB0000;">1.67</span>    1.65    1.00    <span style="text-decoration: underline;">1</span>157.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> position7       2.99<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  4.19<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 1.00   1.01   -<span style="color: #BB0000;">1.59</span>    1.69    1.00    <span style="text-decoration: underline;">1</span>456.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> position8       2.38<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">4.45</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 1.02   1.01   -<span style="color: #BB0000;">1.63</span>    1.75    1.00    <span style="text-decoration: underline;">1</span>503.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> position9      -<span style="color: #BB0000;">3.08</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">3.23</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.01   1.02   -<span style="color: #BB0000;">1.67</span>    1.62    1.00    <span style="text-decoration: underline;">1</span>478.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> position10      2.73<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  1.43<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.01   1.02   -<span style="color: #BB0000;">1.61</span>    1.67    1.00    <span style="text-decoration: underline;">1</span>482.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> target_log_de… -<span style="color: #BB0000;">5.11</span><span style="color: #949494;">e</span>+0 -<span style="color: #BB0000;">4.71</span><span style="color: #949494;">e</span>+0 2.34   2.17   -<span style="color: #BB0000;">9.43</span>   -<span style="color: #BB0000;">2.00</span>    1.00    <span style="text-decoration: underline;">1</span>188.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: ess_tail &lt;dbl&gt;</span></span></span></code></pre></div>
<p>We can also first explicit convert the <code>traces</code> matrix to
a <code>posterior</code> draws object using the
<code>as_draws_matrix</code> function. This can be passed to the
<code>summary</code> generic function to get an equivalent output</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_matrix.html" class="external-link">as_draws_matrix</a></span><span class="op">(</span><span class="va">barker_results</span><span class="op">$</span><span class="va">traces</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">draws</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 11 × 10</span></span></span>
<span><span class="co">#&gt;    variable           mean   median     sd    mad      q5     q95  rhat ess_bulk</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> position1       1.63<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span>  3.51<span style="color: #949494;">e</span><span style="color: #BB0000;">-4</span> 0.010<span style="text-decoration: underline;">2</span> 0.010<span style="text-decoration: underline;">4</span> -<span style="color: #BB0000;">0.016</span><span style="color: #BB0000; text-decoration: underline;">6</span>  0.016<span style="text-decoration: underline;">9</span>  1.00    <span style="text-decoration: underline;">1</span>197.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> position2      -<span style="color: #BB0000;">3.07</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">9.21</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 1.01   0.990  -<span style="color: #BB0000;">1.72</span>    1.62    1.00    <span style="text-decoration: underline;">1</span>405.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> position3       2.22<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  1.54<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.01   1.01   -<span style="color: #BB0000;">1.61</span>    1.64    1.00    <span style="text-decoration: underline;">1</span>191.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> position4       2.13<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  1.25<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.02   1.04   -<span style="color: #BB0000;">1.68</span>    1.68    1.00    <span style="text-decoration: underline;">1</span>250.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> position5       1.78<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  2.02<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 0.993  1.01   -<span style="color: #BB0000;">1.63</span>    1.62    1.00    <span style="text-decoration: underline;">1</span>370.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> position6      -<span style="color: #BB0000;">2.23</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">3.13</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.01   0.996  -<span style="color: #BB0000;">1.67</span>    1.65    1.00    <span style="text-decoration: underline;">1</span>157.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> position7       2.99<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  4.19<span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 1.00   1.01   -<span style="color: #BB0000;">1.59</span>    1.69    1.00    <span style="text-decoration: underline;">1</span>456.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> position8       2.38<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">4.45</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-3</span> 1.02   1.01   -<span style="color: #BB0000;">1.63</span>    1.75    1.00    <span style="text-decoration: underline;">1</span>503.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> position9      -<span style="color: #BB0000;">3.08</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> -<span style="color: #BB0000;">3.23</span><span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.01   1.02   -<span style="color: #BB0000;">1.67</span>    1.62    1.00    <span style="text-decoration: underline;">1</span>478.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> position10      2.73<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span>  1.43<span style="color: #949494;">e</span><span style="color: #BB0000;">-2</span> 1.01   1.02   -<span style="color: #BB0000;">1.61</span>    1.67    1.00    <span style="text-decoration: underline;">1</span>482.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span> target_log_de… -<span style="color: #BB0000;">5.11</span><span style="color: #949494;">e</span>+0 -<span style="color: #BB0000;">4.71</span><span style="color: #949494;">e</span>+0 2.34   2.17   -<span style="color: #BB0000;">9.43</span>   -<span style="color: #BB0000;">2.00</span>    1.00    <span style="text-decoration: underline;">1</span>188.</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: ess_tail &lt;dbl&gt;</span></span></span></code></pre></div>
<p>The draws object can also be manipulated and subsetted with various
functions provided by <code>posterior</code>. For example the <a href="https://mc-stan.org/posterior/reference/extract_variable.html" class="external-link"><code>extract_variable</code>
function</a> can be used to extract the draws for a specific named
variable. The output from this function can then be passed to the
various diagnostic functions, for example to compute the effective
sample size of the mean of the <code>target_log_density</code> variable
we could do the following</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>    <span class="st">"Effective sample size of mean(target_log_density) is %.0f"</span>,</span>
<span>    <span class="fu"><a href="https://mc-stan.org/posterior/reference/ess_mean.html" class="external-link">ess_mean</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/extract_variable.html" class="external-link">extract_variable</a></span><span class="op">(</span><span class="va">draws</span>, <span class="st">"target_log_density"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Effective sample size of mean(target_log_density) is 1206</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="sampling-using-a-langevin-proposal">Sampling using a Langevin proposal<a class="anchor" aria-label="anchor" href="#sampling-using-a-langevin-proposal"></a>
</h2>
<p>To sample a chain using a Langevin proposal, we can simply use
<code>langevin_proposal</code> in place of
<code>baker_proposal</code>.</p>
<p>Here we create a new set of adapters using the default
<code>target_accept_prob</code> argument to <code>scale_adapter</code>
which will set the target acceptance rate to the Langevin proposal
optimal value of 0.574 following the results in <span class="citation">Roberts and Rosenthal (<a href="#ref-roberts2001optimal">2001</a>)</span>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mala_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_chain.html">sample_chain</a></span><span class="op">(</span></span>
<span>  target_distribution <span class="op">=</span> <span class="va">target_distribution</span>,</span>
<span>  proposal <span class="op">=</span> <span class="fu"><a href="../reference/langevin_proposal.html">langevin_proposal</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  initial_state <span class="op">=</span> <span class="va">initial_state</span>,</span>
<span>  n_warm_up_iteration <span class="op">=</span> <span class="va">n_warm_up_iteration</span>,</span>
<span>  n_main_iteration <span class="op">=</span> <span class="va">n_main_iteration</span>,</span>
<span>  adapters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/scale_adapter.html">scale_adapter</a></span><span class="op">(</span>algorithm <span class="op">=</span> <span class="st">"stochastic_approximation"</span>, kappa <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/shape_adapter.html">shape_adapter</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"variance"</span>, kappa <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  trace_warm_up <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can again check the average acceptance rate of the main chain
iterations is close to the specified target value:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>    <span class="st">"Average acceptance probability is %.2f"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mala_results</span><span class="op">$</span><span class="va">statistics</span><span class="op">[</span>, <span class="st">"accept_prob"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Average acceptance probability is 0.61</span></span></code></pre></div>
<p>and use the <code>ess_mean</code> function from the
<code>posterior</code> package to compute the effective sample size of
the mean of the <code>target_log_density</code> variable</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span></span>
<span>    <span class="st">"Effective sample size of mean(target_log_density) is %.0f"</span>,</span>
<span>    <span class="fu"><a href="https://mc-stan.org/posterior/reference/ess_mean.html" class="external-link">ess_mean</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://mc-stan.org/posterior/reference/extract_variable.html" class="external-link">extract_variable</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_matrix.html" class="external-link">as_draws_matrix</a></span><span class="op">(</span><span class="va">mala_results</span><span class="op">$</span><span class="va">traces</span><span class="op">)</span>, <span class="st">"target_log_density"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Effective sample size of mean(target_log_density) is 2863</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="comparing-adaptation-using-barker-and-langevin-proposal">Comparing adaptation using Barker and Langevin proposal<a class="anchor" aria-label="anchor" href="#comparing-adaptation-using-barker-and-langevin-proposal"></a>
</h2>
<p>We can plot how the proposal shape and scale parameters varied during
the adaptive warm-up iterations, by accessing the statistics recorded in
the <code>warm_up_statistics</code> entry in the list returned by
<code>sample_chain</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">visualize_scale_adaptation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">warm_up_statistics</span>, <span class="va">label</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_warm_up_iteration</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">warm_up_statistics</span><span class="op">)</span></span>
<span>  <span class="va">old_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">old_par</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">warm_up_statistics</span><span class="op">[</span>, <span class="st">"log_scale"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Chain iteration "</span>, <span class="va">t</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Scale "</span>, <span class="va">sigma</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">warm_up_statistics</span><span class="op">[</span>, <span class="st">"accept_prob"</span><span class="op">]</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_warm_up_iteration</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Chain iteration "</span>, <span class="va">t</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Average acceptance rate "</span>, <span class="va">alpha</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Scale adaptation for %s"</span>, <span class="va">label</span><span class="op">)</span>,</span>
<span>    side <span class="op">=</span> <span class="fl">3</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, outer <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>First considering the scalar scale parameter
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>σ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\sigma_t</annotation></semantics></math>,
which is controlled to achieve a target average acceptance rate, we see
that for Barker proposal the adaptation successfully coerces the average
acceptance rate to be close to the 0.574 target value and that the scale
parameter adaptation has largely stabilized within the first 1000
iterations.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visualize_scale_adaptation</span><span class="op">(</span><span class="va">barker_results</span><span class="op">$</span><span class="va">warm_up_statistics</span>, <span class="st">"Barker proposal"</span><span class="op">)</span></span></code></pre></div>
<p><img src="barker-proposal_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
<p>For the Langevin proposal on the other hand, while the acceptance
rate does eventually converge to its target value of 0.574, the
convergence is slower and there is more evidence of unstable oscillatory
behaviour in the adapted scale.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visualize_scale_adaptation</span><span class="op">(</span><span class="va">mala_results</span><span class="op">$</span><span class="va">warm_up_statistics</span>, <span class="st">"Langevin proposal"</span><span class="op">)</span></span></code></pre></div>
<p><img src="barker-proposal_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>Now we consider the adaptation of the diagonal shape matrix
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Σ</mi><mi>t</mi></msub><annotation encoding="application/x-tex">\Sigma_t</annotation></semantics></math>,
based on estimates of the per-coordinate variances.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">visualize_shape_adaptation</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">warm_up_statistics</span>, <span class="va">dimensions</span>, <span class="va">label</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">warm_up_statistics</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"variance_estimate"</span>, <span class="va">dimensions</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Chain iteration "</span>, <span class="va">t</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Shape "</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">Sigma</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    log <span class="op">=</span> <span class="st">"y"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>    <span class="st">"right"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"coordinate "</span>, <span class="va">dimensions</span><span class="op">)</span>,</span>
<span>    lty <span class="op">=</span> <span class="va">dimensions</span>,</span>
<span>    col <span class="op">=</span> <span class="va">dimensions</span>,</span>
<span>    bty <span class="op">=</span> <span class="st">"n"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Shape adaptation for %s"</span>, <span class="va">label</span><span class="op">)</span>,</span>
<span>    side <span class="op">=</span> <span class="fl">3</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, outer <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We see that the for the Barker proposal the adaptation quickly
converges towards the known heterogeneous scales along the different
coordinates.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visualize_shape_adaptation</span><span class="op">(</span></span>
<span>  <span class="va">barker_results</span><span class="op">$</span><span class="va">warm_up_statistics</span>, <span class="fl">1</span><span class="op">:</span><span class="va">clipped_dimension</span>, <span class="st">"Barker proposal"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="barker-proposal_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<p>For the Langevin proposal, the shape adaptation is again slower.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visualize_shape_adaptation</span><span class="op">(</span></span>
<span>  <span class="va">mala_results</span><span class="op">$</span><span class="va">warm_up_statistics</span>, <span class="fl">1</span><span class="op">:</span><span class="va">clipped_dimension</span>, <span class="st">"Langevin proposal"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="barker-proposal_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
<p>We can also visualize the chain position components during the
warm-up iterations using the <code>warm_up_traces</code> entry.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">visualize_traces</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">traces</span>, <span class="va">dimensions</span>, <span class="va">label</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span></span>
<span>    <span class="va">traces</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"position"</span>, <span class="va">dimensions</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    type <span class="op">=</span> <span class="st">"l"</span>,</span>
<span>    xlab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Chain iteration "</span>, <span class="va">t</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ylab <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Position "</span>, <span class="va">X</span><span class="op">[</span><span class="va">t</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span></span>
<span>    <span class="st">"topright"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"coordinate "</span>, <span class="va">dimensions</span><span class="op">)</span>,</span>
<span>    lty <span class="op">=</span> <span class="va">dimensions</span>,</span>
<span>    col <span class="op">=</span> <span class="va">dimensions</span>,</span>
<span>    bty <span class="op">=</span> <span class="st">"n"</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/mtext.html" class="external-link">mtext</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Traces for %s"</span>, <span class="va">label</span><span class="op">)</span>, side <span class="op">=</span> <span class="fl">3</span>, line <span class="op">=</span> <span class="op">-</span><span class="fl">2</span>, outer <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For the Barker proposal we can see the chain quickly appears to
converge to a stationary regime</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visualize_traces</span><span class="op">(</span></span>
<span>  <span class="va">barker_results</span><span class="op">$</span><span class="va">warm_up_traces</span>, <span class="fl">1</span><span class="op">:</span><span class="va">clipped_dimension</span>, <span class="st">"Barker proposal"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="barker-proposal_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<p>The Langevin proposal does also appear to converge to a stationary
regime but again convergence is slower</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">visualize_traces</span><span class="op">(</span></span>
<span>  <span class="va">mala_results</span><span class="op">$</span><span class="va">warm_up_traces</span>, <span class="fl">1</span><span class="op">:</span><span class="va">clipped_dimension</span>, <span class="st">"Langevin proposal"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="barker-proposal_files/figure-html/unnamed-chunk-26-1.png" width="672"></p>
<p>Overall we see that while the Langevin proposal is able to achieve a
higher sampling efficiency when tuned with appropriate parameters, its
performance is more sensitive to the tuning parameter values resulting
in less stable and robust adaptive tuning.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-barker1965monte" class="csl-entry">
Barker, Anthony Alfred. 1965. <span>“<span class="nocase">Monte Carlo
calculations of the radial distribution functions for a proton electron
plasma</span>.”</span> <em>Australian Journal of Physics</em> 18 (2):
119–34.
</div>
<div id="ref-livingstone2022barker" class="csl-entry">
Livingstone, Samuel, and Giacomo Zanella. 2022. <span>“<span class="nocase">The Barker proposal: combining robustness and efficiency
in gradient-based MCMC</span>.”</span> <em>Journal of the Royal
Statistical Society Series B: Statistical Methodology</em> 84 (2):
496–523. <a href="https://doi.org/10.1111/rssb.12482" class="external-link">https://doi.org/10.1111/rssb.12482</a>.
</div>
<div id="ref-roberts2001optimal" class="csl-entry">
Roberts, Gareth O, and Jeffrey S Rosenthal. 2001. <span>“<span class="nocase">Optimal scaling for various Metropolis-Hastings
algorithms</span>.”</span> <em>Statistical Science</em> 16 (4): 351–67.
</div>
<div id="ref-vogrinc2023optimal" class="csl-entry">
Vogrinc, Jure, Samuel Livingstone, and Giacomo Zanella. 2023.
<span>“Optimal Design of the Barker Proposal and Other Locally Balanced
Metropolis–Hastings Algorithms.”</span> <em>Biometrika</em> 110 (3):
579–95.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew M. Graham, Samuel Livingstone, Engineering and Physical Sciences Research Council.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>

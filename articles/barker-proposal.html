<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Robust gradient-based MCMC with the Barker proposal • rmcmc</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Robust gradient-based MCMC with the Barker proposal">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rmcmc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/barker-proposal.html">Robust gradient-based MCMC with the Barker proposal</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/UCL/rmcmc/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Robust gradient-based MCMC with the Barker proposal</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/UCL/rmcmc/blob/main/vignettes/barker-proposal.Rmd" class="external-link"><code>vignettes/barker-proposal.Rmd</code></a></small>
      <div class="d-none name"><code>barker-proposal.Rmd</code></div>
    </div>

    
    
<p>The <code>rmcmc</code> package provides a general-purpose
implementation of the Barker proposal <span class="citation">(Barker
1965)</span>, a gradient-based Markov chain Monte Carlo (MCMC) algorithm
inspired by the Barker accept-reject rule, proposed by <span class="citation">Livingstone and Zanella (2022)</span>. This vignette
demonstrates how to use the package to sample Markov chains from a
target distribution of interest, and illustrates the robustness to
tuning that is a key advantage of the Barker proposal compared to
alternatives such as the Metropolis adjusted Langevin algorithm
(MALA).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/UCL/rmcmc" class="external-link">rmcmc</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="example-target-distribution">Example target distribution<a class="anchor" aria-label="anchor" href="#example-target-distribution"></a>
</h2>
<p>As a simple example of a target distribution, we consider a
5-dimensional Gaussian target with heterogeneous scales such that the
standard deviation of the first coordinate is 0.01 and that of other
coordinates is 1. The <code>rmcmc</code> package expects the target
distribution to be specified by a function evaluating the logarithm of
the (potentially unnormalized) probability density at a point, and for
gradient-based methods such as the Barker proposal, additionally
requires specification of a functio evaluating the gradient of this log
density function. The two functions should be wrapped in to a list under
the names <code>log_density</code> and <code>gradient_log_density</code>
respectively.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dimension</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">scales</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">dimension</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">target_distribution</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  log_density <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="op">(</span><span class="va">x</span> <span class="op">/</span> <span class="va">scales</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span>,</span>
<span>  gradient_log_density <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span><span class="va">x</span> <span class="op">/</span> <span class="va">scales</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-proposal-distribution">Creating proposal distribution<a class="anchor" aria-label="anchor" href="#creating-proposal-distribution"></a>
</h2>
<p><code>rmcmc</code> provides implementations of several different
proposal distributions which can be used within a Metropolis–Hastings
based MCMC method:</p>
<ul>
<li>
<code>barker_proposal</code>: The robust gradient-based Barker
proposal proposed by <span class="citation">Livingstone and Zanella
(2022)</span>.</li>
<li>
<code>langevin_proposal</code>: A gradient-based proposal based on a
discretization of a Langevin dynamics.</li>
<li>
<code>random_walk_proposal</code>: A Gaussian random-walk
proposal.</li>
</ul>
<p>Each function requires the first argument to specify the target
distribution the proposal is to be constructed for. Optionally
additional arguments can be used to specify the scalar
<code>scale</code> of the proposal, a vector or matrix defining the
proposal <code>shape</code> and routines to sample the auxiliary
variables used in the proposal.</p>
<p>Here we create an instance of the Barker proposal, specifying only
the target distribution with the other arguments left as their defaults.
Rather than specifying fixed <code>scale</code> and <code>shape</code>
tuning parameters, in the next section we illustrate how to set up
adaptation of these parameters during a warm-up stage to the chains.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">proposal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/barker_proposal.html">barker_proposal</a></span><span class="op">(</span><span class="va">target_distribution</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="setting-up-adaptation-of-tuning-parameters">Setting up adaptation of tuning parameters<a class="anchor" aria-label="anchor" href="#setting-up-adaptation-of-tuning-parameters"></a>
</h2>
<p><code>rmcmc</code> has support for adaptively tuning parameters of
the proposal distribution. This is mediated by ‘adapter’ objects which
define method for update the parameters of a proposal based on the chain
state and statistics recorded during a chain iteration. Below we
instantiate a list of adapters to (i) adapt the scalar scale of the
proposal distribution to coerce the average acceptance probability of
the chain transitions to a target value, and (ii) adapt the shape of the
proposal distribution with per-coordinate scaling factors based on
estimates on the coordinate-wise variances under the target
distribution.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adapters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/scale_adapter.html">scale_adapter</a></span><span class="op">(</span><span class="va">proposal</span>, initial_scale <span class="op">=</span> <span class="fl">1.</span>, target_accept_prob <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/variance_adapter.html">variance_adapter</a></span><span class="op">(</span><span class="va">proposal</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The adapter updates will be applied only during an initial set of
‘warm-up’ chain iterations, with the proposal parameters remaining fixed
to their final adapted values during a subsequent set of main chain
iterations.</p>
</div>
<div class="section level2">
<h2 id="sampling-a-chain">Sampling a chain<a class="anchor" aria-label="anchor" href="#sampling-a-chain"></a>
</h2>
<p>To sample a chain we first need to specify the initial chain state.
The <code>rmcmc</code> package encapsulates the chain state in a list
which tracks the current position of the chain, but also additional
quantities such as the auxiliary variables used to generate the proposed
perturbation to the state, and cached values of the log density and its
gradient once computed once at the current position to avoid
re-computation. The <code>chain_state</code> function allows creation of
a list of the required format, with the first (and only required)
argument specifying the position. Here we generate an initial state with
position coordinates sampled from a standard normal distribution.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">initial_state</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chain_state.html">chain_state</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">dimension</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We now have everything needed to sample a Markov chain. To do this we
use the <code>sample_chain</code> function from <code>rmcmc</code>. This
requires us to specify the target distribution, proposal distribution,
initial chain state, number of adaptive warm-up iterations and
non-adaptive main chain iterations and list of adapters to use. Here we
sample a chain with 5000 warm-up and 5000 main chain iterations.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_chain.html">sample_chain</a></span><span class="op">(</span></span>
<span>  target_distribution <span class="op">=</span> <span class="va">target_distribution</span>,</span>
<span>  proposal <span class="op">=</span> <span class="va">proposal</span>,</span>
<span>  initial_state <span class="op">=</span> <span class="va">initial_state</span>,</span>
<span>  n_warm_up_iteration <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  n_main_iteration <span class="op">=</span> <span class="fl">5000</span>,</span>
<span>  adapters <span class="op">=</span> <span class="va">adapters</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If the <code>progress</code> package is installed a progress bar will
show the chain progress during sampling. The return value of
<code>sample_chains</code> is a list containing fields for accessing the
final chain state (which can be used to start sampling a new chain), any
variables traced during the main chain iterations and any transition
statistics recorded.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_accept_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">statistics</span><span class="op">$</span><span class="va">accept_prob</span><span class="op">)</span></span>
<span><span class="va">adapted_shape</span> <span class="op">&lt;-</span> <span class="va">proposal</span><span class="op">$</span><span class="fu">parameters</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">shape</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Average acceptance probability is %.2f"</span>, <span class="va">mean_accept_prob</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"True target scales: %s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/toString.html" class="external-link">toString</a></span><span class="op">(</span><span class="va">scales</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Adapter scale est.: %s"</span>, <span class="fu"><a href="https://rdrr.io/r/base/toString.html" class="external-link">toString</a></span><span class="op">(</span><span class="va">adapted_shape</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  sep <span class="op">=</span> <span class="st">"\n"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Average acceptance probability is 0.39</span></span>
<span><span class="co">#&gt; True target scales: 0.01, 1, 1, 1, 1</span></span>
<span><span class="co">#&gt; Adapter scale est.: 0.00911327292692519, 0.822701109616858, 0.94202243826012, 0.959821317237303, 0.82054653914399</span></span></code></pre></div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-barker1965monte" class="csl-entry">
Barker, Anthony Alfred. 1965. <span>“<span class="nocase">Monte Carlo
calculations of the radial distribution functions for a proton electron
plasma</span>.”</span> <em>Australian Journal of Physics</em> 18 (2):
119–34.
</div>
<div id="ref-livingstone2022barker" class="csl-entry">
Livingstone, Samuel, and Giacomo Zanella. 2022. <span>“<span class="nocase">The Barker proposal: combining robustness and efficiency
in gradient-based MCMC</span>.”</span> <em>Journal of the Royal
Statistical Society Series B: Statistical Methodology</em> 84 (2):
496–523. https://doi.org/<a href="https://doi.org/10.1111/rssb.12482" class="external-link">https://doi.org/10.1111/rssb.12482</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Matthew M. Graham, Samuel Livingstone, Engineering and Physical Sciences Research Council.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
